/**
 * jQuery ddMultipleInput Plugin
 * @version: 1.1 (2013-05-30)
 * 
 * @uses jQuery 1.7.2, jQuery-ui 1.10 autocomplete
 * 
 * @param source {array} - Источник данных для ввода (то, что будет в выпадающем списке). @required
 * @param separator {string} - Разделитель между значениями. По умолачанию: ','.
 * @param allowDoubling {boolean} - Разрешить ли выбор одинаковых значений. по умолчанию: false.
 * @param max {integer} - Максимальное количество выбранных значений (при == 0 — без ограничений). По умолчанию: 0. 
 *
 * @copyright 2013, DivanDesign
 * http://www.DivanDesign.biz
 */

(function(b){b.fn.ddMultipleInput=function(c){c=b.extend({separator:",",allowDoubling:!1,max:0},c||{});if(c.source)return"string"==b.type(c.source[0])&&b.each(c.source,function(a,b){c.source[a]={label:b,value:b}}),b(this).each(function(){var a=b(this),f=b.trim(a.val()),d=b('<div class="ddMultipleInput"></div>'),e=b('<input type="text" value="" />'),m={display:"inline-block",width:a.width()||"auto","padding-top":0,"padding-right":0,"padding-bottom":a.css("padding-bottom"),"padding-left":0,"border-top":a.css("border-top"),
"border-right":a.css("border-right"),"border-bottom":a.css("border-bottom"),"border-left":a.css("border-left"),"border-color":a.css("border-color"),"border-radius":a.css("border-radius"),overflow:"hidden","background-image":a.css("background-image"),"background-repeat":a.css("background-repeat"),"background-color":a.css("background-color"),"box-shadow":a.css("box-shadow"),cursor:"text","font-family":a.css("font-family"),"font-size":a.css("font-size"),"font-style":a.css("font-style"),"font-weight":a.css("font-weight"),
"line-height":a.css("line-height"),color:a.css("color"),"text-shadow":a.css("text-shadow"),"white-space":"normal"};a.on("ddMIaddItem",function(r,g){if(g&&b.isPlainObject(g)){e.val("").css({width:"1em"});e.before(b('<span data-value="'+g.value+'" data-label="'+g.label+'">'+g.label+" \u00d7</span>").css({display:"inline-block",margin:a.css("padding-top")+" "+a.css("padding-right")+" 0 "+a.css("padding-left"),border:"1px solid "+m["border-color"],padding:"0 0.38em","border-radius":"3px",cursor:"pointer"}));
f.push(g.value);if(!c.allowDoubling){for(var j=e.autocomplete("option","source"),d=0,h=j.length;d<h;d++)if(j[d].value==g.value){j.splice(d,1);break}e.autocomplete("option","source",j)}0!=c.max&&f.length==c.max&&e.hide()}});a.on("ddMIremoveItem",function(a,b){b&&""!=$trim(b)&&d.find('span[data-value="'+b+'"]').trigger("click")});a.on("ddMIopen",function(){e.autocomplete("search","")});a.on("ddMIclose",function(){e.autocomplete("close")});d.on("click","span",function(){var a=b(this),g=a.attr("data-value"),
d=b.inArray(g,f);-1!=d&&(f.splice(d,1),c.allowDoubling||(d=e.autocomplete("option","source"),d.push({label:a.attr("data-label"),value:g}),e.autocomplete("option","source",d)),0!=c.max&&e.show());a.remove()});d.on("click",function(){e.trigger("focus")}).on("dblclick",function(){(0==c.max||f.length<c.max)&&a.trigger("ddMIopen")});e.on("focusin",function(){d.addClass("focus")}).on("focusout",function(){d.removeClass("focus");a.val(f.join(c.separator))}).on("keydown",function(a){var c=b(this),e=c.val();
a.keyCode===b.ui.keyCode.TAB&&c.data("ui-autocomplete").menu.active&&a.preventDefault();a.keyCode===b.ui.keyCode.BACKSPACE&&""==e&&d.find("span:last").trigger("click");c.css({width:e.length+1+"em"})});d.css(m).insertBefore(a);e.css({width:"1em",padding:"0",border:"none",margin:"0","box-shadow":"none",outline:"none"});a.appendTo(d).hide();e.appendTo(d);a.data("ddMultipleInput",e);e.autocomplete({minLength:0,delay:0,source:b.extend([],c.source),select:function(b,c){a.trigger("ddMIaddItem",[c.item]);
return!1}});if(""!=f)for(var n=f.split(c.separator),f=[],k=0,p=n.length;k<p;k++){for(var l=!1,h=0,q=c.source.length;h<q;h++)if(c.source[h].value==n[k]){l=c.source[h];break}!1!==l&&a.trigger("ddMIaddItem",[l])}else f=[]})}})(jQuery);